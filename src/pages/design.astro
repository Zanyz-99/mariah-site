---
import Layout from "../layouts/Layout.astro";

const slides = [
  "/design/circle_square.png",
  "/design/02 Project Two.png",
  "/design/03 Project Three.png",
  "/design/04 Project Four.png",
];

const projects = [
  { name: "Circle Within a Square", desc: `Inspired by my grandfather’s relentless obsession with circles-within-squares, I approached this studio with the intention of finding a ‘close-body’ architecture version of this form.` },
  { name: "Project Two", desc: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris." },
  { name: "Project Three", desc: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duis aute irure dolor in reprehenderit in voluptate velit esse." },
  { name: "Project Four", desc: "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Excepteur sint occaecat cupidatat non proident, sunt in culpa." },
];

// ✅ Each project gets a route
// (matches: mariah-site/src/pages/design/circle_square.astro => /design/circle_square)
const links = [
  "/design/circle_square",
  "/design/project-two",
  "/design/project-three",
  "/design/project-four",
];
---

<Layout title="Design" description="">
  <section class="home" id="design-home">
    <div class="full-bleed">
      <div class="carousel" id="projects">
        <div class="viewport" id="viewport" tabindex="0" aria-label="Design carousel">
          <div class="window" id="window">
            <ul class="track" id="track" aria-live="polite">
              <li class="card">
                <a class="card-link" id="link-prev" href="#">
                  <div class="media">
                    <img class="img-main" id="img-prev" alt="Previous design project" decoding="async" />
                  </div>
                  <div class="meta" aria-hidden="true">
                    <div class="title" id="title-prev"></div>
                    <div class="desc" id="desc-prev"></div>
                  </div>
                </a>
              </li>

              <li class="card is-active" id="card-cur">
                <a class="card-link" id="link-cur" href="#">
                  <div class="media">
                    <img class="img-main" id="img-cur" alt="Current design project" decoding="async" fetchpriority="high" />
                  </div>
                  <div class="meta">
                    <div class="title" id="title-cur"></div>
                    <div class="desc" id="desc-cur"></div>
                  </div>
                </a>
              </li>

              <li class="card">
                <a class="card-link" id="link-next" href="#">
                  <div class="media">
                    <img class="img-main" id="img-next" alt="Next design project" decoding="async" />
                  </div>
                  <div class="meta" aria-hidden="true">
                    <div class="title" id="title-next"></div>
                    <div class="desc" id="desc-next"></div>
                  </div>
                </a>
              </li>
            </ul>
          </div>
        </div>
        <!-- dots removed -->
      </div>
    </div>
  </section>

  <script define:vars={{ slides, projects, links }}>
    const home = document.getElementById("design-home");
    const viewport = document.getElementById("viewport");
    const track = document.getElementById("track");
    const cardCur = document.getElementById("card-cur");

    const imgPrev = document.getElementById("img-prev");
    const imgCur  = document.getElementById("img-cur");
    const imgNext = document.getElementById("img-next");

    const titlePrev = document.getElementById("title-prev");
    const titleCur  = document.getElementById("title-cur");
    const titleNext = document.getElementById("title-next");

    const descPrev = document.getElementById("desc-prev");
    const descCur  = document.getElementById("desc-cur");
    const descNext = document.getElementById("desc-next");

    // ✅ NEW: link elements
    const linkPrev = document.getElementById("link-prev");
    const linkCur  = document.getElementById("link-cur");
    const linkNext = document.getElementById("link-next");

    const n = slides.length;
    const mod = (x) => (x % n + n) % n;

    let index = 0;
    let animating = false;
    let baseX = 0;

    // Drag state (so links still click)
    let startX = 0;
    let pointerId = null;
    let didMove = false;
    let handlingLinkClick = false;

    // Preload main images
    const preloaded = new Set();
    const preload = (src) => {
      if (!src || preloaded.has(src)) return;
      preloaded.add(src);
      const im = new Image();
      im.decoding = "async";
      im.src = src;
    };
    slides.forEach(preload);

    const setMeta = (i, titleEl, descEl) => {
      const p = projects[i] || { name: "Project", desc: "" };
      titleEl.textContent = p.name;
      descEl.textContent = p.desc;
    };

    const setLinks = () => {
      const prevI = mod(index - 1);
      const curI  = index;
      const nextI = mod(index + 1);

      // fallback to "#" if missing
      linkPrev.href = links?.[prevI] ?? "#";
      linkCur.href  = links?.[curI]  ?? "#";
      linkNext.href = links?.[nextI] ?? "#";
    };

    const setImages = () => {
      imgPrev.src = slides[mod(index - 1)];
      imgCur.src  = slides[index];
      imgNext.src = slides[mod(index + 1)];

      imgPrev.loading = "eager";
      imgCur.loading  = "eager";
      imgNext.loading = "eager";

      setMeta(mod(index - 1), titlePrev, descPrev);
      setMeta(index,          titleCur,  descCur);
      setMeta(mod(index + 1), titleNext, descNext);

      setLinks();
    };

    const gapPx = () => {
      const cs = getComputedStyle(track);
      return parseFloat(cs.columnGap || cs.gap || "0") || 0;
    };

    const cardWidth = () => {
      const card = track.querySelector(".card");
      return card ? card.getBoundingClientRect().width : 0;
    };

    const stepDistance = () => Math.round(cardWidth() + gapPx());

    // ✅ Convert any CSS length to pixels
    const toPx = (cssLen) => {
      const v = (cssLen ?? "").toString().trim();
      if (!v) return 0;
      if (v.endsWith("px")) return parseFloat(v) || 0;

      const el = document.createElement("div");
      el.style.position = "absolute";
      el.style.visibility = "hidden";
      el.style.pointerEvents = "none";
      el.style.height = v;
      el.style.left = "-9999px";
      el.style.top = "-9999px";
      document.body.appendChild(el);
      const px = el.getBoundingClientRect().height || 0;
      document.body.removeChild(el);
      return px;
    };

    const updateSizingVars = () => {
      if (!home) return;
      const cs = getComputedStyle(home);

      const pt = parseFloat(cs.paddingTop || "0") || 0;
      const pb = parseFloat(cs.paddingBottom || "0") || 0;

      const chrome = toPx(cs.getPropertyValue("--chrome") || "0px");
      const metaH = toPx(cs.getPropertyValue("--meta-h") || "180px");
      const fixedCardH = toPx(cs.getPropertyValue("--card-h-fixed") || "640px");

      const viewportH = window.visualViewport?.height || window.innerHeight;

      const availableCardH = Math.max(260, Math.floor(viewportH - chrome - pt - pb));
      const cardH = Math.min(Math.floor(fixedCardH), availableCardH);

      const safeMetaH = Math.min(Math.floor(metaH), Math.max(120, cardH - 120));
      const mediaH = Math.max(120, Math.floor(cardH - safeMetaH));

      const cardW = Math.floor((mediaH * 16) / 9);

      home.style.setProperty("--card-h", `${cardH}px`);
      home.style.setProperty("--media-h", `${mediaH}px`);
      home.style.setProperty("--card-w", `${cardW}px`);
    };

    const computeBaseX = () => {
      const v = viewport.getBoundingClientRect();
      const c = cardCur.getBoundingClientRect();

      const viewportCenter = v.left + v.width / 2;
      const cardCenter = c.left + c.width / 2;

      baseX += (viewportCenter - cardCenter);
      baseX = Math.round(baseX);

      track.style.transition = "none";
      track.style.transform = `translate3d(${baseX}px, 0, 0)`;
      track.offsetHeight;
    };

    const step = (dir) => {
      if (animating) return;
      animating = true;

      const dist = stepDistance();

      track.style.transition = "transform 320ms ease";
      track.style.transform = `translate3d(${baseX + (dir === 1 ? -dist : dist)}px, 0, 0)`;

      const onDone = () => {
        track.removeEventListener("transitionend", onDone);

        index = mod(index + dir);
        setImages();

        updateSizingVars();

        track.style.transition = "none";
        track.style.transform = `translate3d(${baseX}px, 0, 0)`;
        track.offsetHeight;

        computeBaseX();
        animating = false;
      };

      track.addEventListener("transitionend", onDone);
    };

    // wheel anywhere
    let wheelLock = false;
    window.addEventListener(
      "wheel",
      (e) => {
        e.preventDefault();
        if (wheelLock || animating) return;
        wheelLock = true;

        const dominant = Math.abs(e.deltaY) >= Math.abs(e.deltaX) ? e.deltaY : e.deltaX;
        step(dominant > 0 ? 1 : -1);

        setTimeout(() => (wheelLock = false), 360);
      },
      { passive: false }
    );

    // ✅ pointer handling that doesn't break <a> clicks
    viewport.addEventListener("pointerdown", (e) => {
      if (animating) return;

      const onLink = !!e.target.closest("a.card-link");
      handlingLinkClick = onLink;

      startX = e.clientX;
      didMove = false;
      pointerId = e.pointerId;

      if (!onLink) viewport.setPointerCapture?.(e.pointerId);
    });

    viewport.addEventListener("pointermove", (e) => {
      if (pointerId == null || e.pointerId !== pointerId) return;
      if (handlingLinkClick) return;

      if (Math.abs(e.clientX - startX) > 8) didMove = true;
    });

    viewport.addEventListener("pointerup", (e) => {
      if (pointerId == null || e.pointerId !== pointerId) return;

      const wasLink = handlingLinkClick;
      pointerId = null;
      handlingLinkClick = false;

      // Let the browser navigate if the interaction started on a link
      if (wasLink) return;

      if (animating) return;

      const dx = e.clientX - startX;
      const threshold = Math.min(90, viewport.clientWidth * 0.14);

      if (dx < -threshold) step(1);
      else if (dx > threshold) step(-1);
    });

    viewport.addEventListener("pointercancel", () => {
      pointerId = null;
      handlingLinkClick = false;
      didMove = false;
    });

    // keyboard
    window.addEventListener("keydown", (e) => {
      if (animating) return;
      if (e.key === "ArrowRight") step(1);
      if (e.key === "ArrowLeft") step(-1);
    });

    // resize
    let resizeT;
    window.addEventListener("resize", () => {
      clearTimeout(resizeT);
      resizeT = setTimeout(() => {
        updateSizingVars();
        computeBaseX();
      }, 60);
    });

    // init
    setImages();
    requestAnimationFrame(() => {
      updateSizingVars();
      requestAnimationFrame(() => {
        baseX = 0;
        track.style.transform = "translate3d(0,0,0)";
        computeBaseX();
      });
    });
  </script>

  <style>
    :global(html),
    :global(body){
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    .home{
      --chrome: 72px;
      --card-h-fixed: 72svh;
      --meta-h: clamp(150px, 18svh, 220px);

      --card-h: 640px;
      --media-h: 460px;
      --card-w: 820px;

      display: grid;
      gap: 16px;
      width: 100%;
      padding-top: clamp(12px, 3vh, 28px);
      padding-bottom: clamp(18px, 4vh, 44px);
      box-sizing: border-box;

      height: calc(100svh - var(--chrome));
    }

    .carousel{ width: 100%; }

    .viewport{
      width: 100%;
      height: 100%;
      overflow: hidden;
      outline: none;
      touch-action: pan-y;
      box-sizing: border-box;

      display: flex;
      justify-content: center;
      align-items: center;
    }

    .window{
      width: min(100vw, clamp(320px, 78vw, 980px));
      overflow: visible;
    }

    .track{
      display: flex;
      align-items: center;
      gap: clamp(10px, 2vw, 18px);
      padding: 6px 0;
      will-change: transform;
      transform: translate3d(0,0,0);
    }

    .card{
      flex: 0 0 auto;
      height: var(--card-h);
      width: min(92vw, var(--card-w));

      border-radius: 16px;
      overflow: hidden;

      background: var(--card);
      border: 1px solid var(--border);

      opacity: 0.92;
      transition: opacity 200ms ease;

      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .card.is-active{ opacity: 1; }

    /* ✅ Make the whole card clickable */
    .card-link{
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      text-decoration: none;
      color: inherit;
    }

    .media{
      height: var(--media-h);
      width: 100%;
      position: relative;
      overflow: hidden;
      background: var(--card);
    }

    .img-main{
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      object-position: center;
      user-select: none;
      -webkit-user-drag: none;

      filter: grayscale(100%) saturate(0.9);
      transition: filter 220ms ease;
    }

    .card:hover .img-main,
    .card:focus-within .img-main{ filter: none; }

    .meta{
      height: calc(var(--card-h) - var(--media-h));
      width: 100%;
      box-sizing: border-box;

      padding: 14px 16px 16px;
      display: grid;
      gap: 8px;
    }

    .title{
      font-weight: 700;
      font-size: clamp(16px, 1.6vw, 20px);
      line-height: 1.2;
    }

    .desc{
      font-size: clamp(13px, 1.25vw, 15px);
      line-height: 1.45;
      opacity: 0.85;

      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
      overflow: hidden;
    }

    @media (max-width: 640px){
      .window{
        width: 100vw;
        overflow: hidden;
      }

      .track{
        gap: 0;
        padding: 0;
      }

      .desc{
        -webkit-line-clamp: 4;
      }
    }

    @media (prefers-reduced-motion: reduce){
      .card,
      .img-main{
        transition: none !important;
      }
    }
  </style>
</Layout>
