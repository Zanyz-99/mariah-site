---
import Layout from "../layouts/Layout.astro";

const slides = [
  "/projects/02 Project Two.png",
  "/projects/03 Project Three.png",
  "/projects/04 Project Four.png",
  "/projects/05 Project Five.png",
  "/projects/06 Project Six.png",
];
---

<Layout title="Home" description="">
  <section class="content home-wrap">
    <div class="projects" id="projects">
      <div
        class="viewport"
        id="viewport"
        aria-label="Projects carousel"
        tabindex="0"
      >
        <ul class="track" id="track" aria-live="polite">
          <!-- prev | current | next (3 panes only) -->
          <li class="pane"><img id="img-prev" alt="Previous project" decoding="async" /></li>
          <li class="pane"><img id="img-cur"  alt="Current project" decoding="async" /></li>
          <li class="pane"><img id="img-next" alt="Next project" decoding="async" /></li>
        </ul>
      </div>

      <div class="dots" id="dots" role="tablist" aria-label="Project slide navigation">
        {slides.map((_, i) => (
          <button
            class="dot"
            type="button"
            data-index={i}
            aria-label={`Go to slide ${i + 1}`}
          />
        ))}
      </div>
    </div>
  </section>

  <script define:vars={{ slides }}>
    const viewport = document.getElementById("viewport");
    const track = document.getElementById("track");
    const dots = document.querySelectorAll("#dots .dot");

    const imgPrev = document.getElementById("img-prev");
    const imgCur  = document.getElementById("img-cur");
    const imgNext = document.getElementById("img-next");

    const n = slides.length;
    const mod = (x) => (x % n + n) % n;

    let index = 0;        // logical current index
    let animating = false;

    // Ensure the track starts centered on the middle pane
    const setTrackCenter = () => {
      track.style.transition = "none";
      track.style.transform = "translateX(-100%)";
      // force reflow so transition-less transform is applied
      track.offsetHeight;
    };

    const setDots = () => {
      dots.forEach((d, i) => {
        if (i === index) d.setAttribute("data-active", "true");
        else d.removeAttribute("data-active");
        d.setAttribute("aria-selected", i === index ? "true" : "false");
      });
    };

    const setPaneImages = () => {
      const prev = mod(index - 1);
      const next = mod(index + 1);

      imgPrev.src = slides[prev];
      imgCur.src  = slides[index];
      imgNext.src = slides[next];

      // Make the current one eager-ish (helps perceived performance)
      imgCur.loading = "eager";
      imgPrev.loading = "lazy";
      imgNext.loading = "lazy";
    };

    // Move one step: dir = +1 (next) or -1 (prev)
    const step = (dir) => {
      if (animating) return;
      animating = true;

      track.style.transition = "transform 320ms ease";
      track.style.transform = dir === 1 ? "translateX(-200%)" : "translateX(0%)";

      const onDone = () => {
        track.removeEventListener("transitionend", onDone);

        index = mod(index + dir);
        setPaneImages();
        setDots();

        // snap back to center pane without animation
        setTrackCenter();

        animating = false;
      };

      track.addEventListener("transitionend", onDone);
    };

    const goTo = (target) => {
      target = mod(target);
      if (target === index || animating) return;

      // If it's adjacent, animate. If not, jump (no weird multi-step delay).
      const forward = mod(target - index);
      const backward = mod(index - target);

      if (forward === 1) return step(1);
      if (backward === 1) return step(-1);

      index = target;
      setPaneImages();
      setDots();
      setTrackCenter();
    };

    // Dots
    dots.forEach((dot) => {
      dot.addEventListener("click", () => {
        const t = Number(dot.getAttribute("data-index"));
        goTo(t);
      });
    });

    // Mouse wheel / trackpad paging
    let wheelLock = false;
    viewport.addEventListener(
      "wheel",
      (e) => {
        // hijack wheel only inside the viewport
        e.preventDefault();
        if (wheelLock || animating) return;
        wheelLock = true;

        // Use whichever axis is dominant (trackpads can be deltaX-heavy)
        const dominant = Math.abs(e.deltaY) >= Math.abs(e.deltaX) ? e.deltaY : e.deltaX;
        if (dominant > 0) step(1);
        else step(-1);

        setTimeout(() => (wheelLock = false), 340);
      },
      { passive: false }
    );

    // Keyboard
    viewport.addEventListener("keydown", (e) => {
      if (animating) return;
      if (e.key === "ArrowRight") step(1);
      if (e.key === "ArrowLeft") step(-1);
    });

    // Drag / swipe (snap on release)
    let startX = 0;
    let dragging = false;

    viewport.addEventListener("pointerdown", (e) => {
      if (animating) return;
      dragging = true;
      startX = e.clientX;
      viewport.setPointerCapture?.(e.pointerId);
    });

    viewport.addEventListener("pointerup", (e) => {
      if (!dragging || animating) return;
      dragging = false;

      const dx = e.clientX - startX;
      const threshold = Math.min(90, viewport.clientWidth * 0.18);

      if (dx < -threshold) step(1);
      else if (dx > threshold) step(-1);
    });

    viewport.addEventListener("pointercancel", () => {
      dragging = false;
    });

    // Init
    setPaneImages();
    setDots();
    setTrackCenter();
  </script>

  <style>
    .home-wrap{
      display: grid;
      gap: 16px;
      justify-items: start;
      align-items: start;
      margin-inline: auto;
      width: 100%;
      padding-top: clamp(16px, 4vh, 48px);
      padding-bottom: clamp(24px, 6vh, 64px);
    }

    .projects{
      width: 100%;
      max-width: 980px;
    }

    .viewport{
      width: 100%;
      overflow: hidden;
      border-radius: 16px;

      /* keeps it from being gigantic */
      height: clamp(220px, 45vh, 520px);

      outline: none;
      /* allow pointer events; wheel is handled explicitly */
      touch-action: pan-y;
    }

    /* 3 panes, each 100% width */
    .track{
      display: flex;
      width: 300%;
      transform: translateX(-100%);
    }

    .pane{
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .pane img{
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      object-position: center;
      user-select: none;
      -webkit-user-drag: none;
    }

    /* dots */
    .dots{
      margin-top: 0.9rem;
      display: flex;
      justify-content: center;
      gap: 10px;
      width: 100%;
    }

    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 0;
      background: currentColor;
      opacity: 0.35;
      cursor: pointer;
      transition: transform 160ms ease, opacity 160ms ease;
      position: relative;
    }

    .dot[data-active="true"]{
      opacity: 1;
      transform: scale(1.35);
    }

    .dot::before{
      content: "";
      position: absolute;
      inset: -10px;
    }
  </style>
</Layout>
