---
import Layout from "../layouts/Layout.astro";

const slides = [
  "/projects/amplitude.png",
  "/projects/immersion.png",
  "/projects/symbiosis.png",
  "/projects/tini.png",
];

// Covers (project name images)
const covers = [
  "/projects/Project Cover/Project One.png",
  "/projects/Project Cover/Project Two.png",
  "/projects/Project Cover/Project Three.png",
  "/projects/Project Cover/Project Four.png",
];
---

<Layout title="Home" description="">
  <section class="home">
    <div class="full-bleed">
      <div class="carousel" id="projects">
        <div class="viewport" id="viewport">
          <div class="window">
            <ul class="track" id="track">
              <li class="card" id="card-prev" data-href="">
                <div class="media">
                  <img class="img-main" id="img-prev" />
                  <img class="img-cover" id="cover-prev" />
                </div>
              </li>

              <li class="card is-active" id="card-cur" data-href="">
                <div class="media">
                  <img class="img-main" id="img-cur" />
                  <img class="img-cover" id="cover-cur" />
                </div>
              </li>

              <li class="card" id="card-next" data-href="">
                <div class="media">
                  <img class="img-main" id="img-next" />
                  <img class="img-cover" id="cover-next" />
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script define:vars={{ slides, covers }}>
    const viewport = document.getElementById("viewport");
    const track = document.getElementById("track");

    const cards = {
      prev: document.getElementById("card-prev"),
      cur: document.getElementById("card-cur"),
      next: document.getElementById("card-next"),
    };

    const imgs = {
      prev: document.getElementById("img-prev"),
      cur: document.getElementById("img-cur"),
      next: document.getElementById("img-next"),
    };

    const coversEl = {
      prev: document.getElementById("cover-prev"),
      cur: document.getElementById("cover-cur"),
      next: document.getElementById("cover-next"),
    };

    const n = slides.length;
    const mod = (x) => (x % n + n) % n;

    let index = 0;
    let baseX = 0;
    let animating = false;

    let startX = 0;
    let dragged = false;

    const pageFromSlide = (src) => src.replace(/\.png$/i, "");

    const setImages = () => {
      const prev = slides[mod(index - 1)];
      const cur  = slides[index];
      const next = slides[mod(index + 1)];

      imgs.prev.src = prev;
      imgs.cur.src  = cur;
      imgs.next.src = next;

      coversEl.prev.src = covers[mod(index - 1)];
      coversEl.cur.src  = covers[index];
      coversEl.next.src = covers[mod(index + 1)];

      cards.prev.dataset.href = pageFromSlide(prev);
      cards.cur.dataset.href  = pageFromSlide(cur);
      cards.next.dataset.href = pageFromSlide(next);
    };

    const cardWidth = () =>
      track.querySelector(".card").getBoundingClientRect().width;

    const gapPx = () =>
      parseFloat(getComputedStyle(track).gap || 0);

    const stepDistance = () => cardWidth() + gapPx();

    const computeBaseX = () => {
      const v = viewport.getBoundingClientRect();
      const c = cards.cur.getBoundingClientRect();
      baseX += v.left + v.width / 2 - (c.left + c.width / 2);
      track.style.transition = "none";
      track.style.transform = `translate3d(${Math.round(baseX)}px,0,0)`;
    };

    const step = (dir) => {
      if (animating) return;
      animating = true;

      const dist = stepDistance();
      track.style.transition = "transform 320ms ease";
      track.style.transform = `translate3d(${baseX + (dir === 1 ? -dist : dist)}px,0,0)`;

      track.addEventListener(
        "transitionend",
        () => {
          index = mod(index + dir);
          setImages();
          track.style.transition = "none";
          track.style.transform = `translate3d(${baseX}px,0,0)`;
          computeBaseX();
          animating = false;
        },
        { once: true }
      );
    };

    // ---------- pointer handling ----------
    viewport.addEventListener("pointerdown", (e) => {
      startX = e.clientX;
      dragged = false;
    });

    viewport.addEventListener("pointermove", (e) => {
      if (Math.abs(e.clientX - startX) > 8) dragged = true;
    });

    viewport.addEventListener("pointerup", (e) => {
      if (!dragged) {
        const card = e.target.closest(".card");
        if (card?.dataset.href) {
          window.location.href = card.dataset.href;
          return;
        }
      }

      if (animating) return;

      const dx = e.clientX - startX;
      const threshold = viewport.clientWidth * 0.12;

      if (dx < -threshold) step(1);
      else if (dx > threshold) step(-1);
    });

    window.addEventListener("keydown", (e) => {
      if (e.key === "ArrowRight") step(1);
      if (e.key === "ArrowLeft") step(-1);
    });

    setImages();
    requestAnimationFrame(computeBaseX);
  </script>

  <style>
    :global(html, body){
      height:100%;
      margin:0;
      overflow:hidden;
    }

    .viewport{
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      touch-action:pan-y;
    }

    .window{
      width:min(100vw, 980px);
      overflow:visible;
    }

    .track{
      display:flex;
      gap:16px;
      will-change:transform;
    }

    .card{
      width:clamp(320px,78vw,980px);
      aspect-ratio:16/9;
      border-radius:16px;
      overflow:hidden;
      cursor:pointer;
      background:#111;
    }

    .media{
      position:relative;
      width:100%;
      height:100%;
    }

    .img-main,
    .img-cover{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .img-main{
      filter:grayscale(100%);
      transition:filter 200ms ease;
    }

    .img-cover{
      opacity:0.28;
      transition:opacity 200ms ease;
      pointer-events:none;
    }

    .card:hover .img-main{ filter:none; }
    .card:hover .img-cover{ opacity:0; }
  </style>
</Layout>
