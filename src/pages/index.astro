---
import Layout from "../layouts/Layout.astro";

const slides = [
  "/projects/02 Project Two.png",
  "/projects/03 Project Three.png",
  "/projects/04 Project Four.png",
  "/projects/05 Project Five.png",
  "/projects/06 Project Six.png",
];
---

<Layout title="Home" description="">
  <section class="content home-wrap">
    <div class="projects" id="projects">
      <div
        class="viewport"
        id="viewport"
        aria-label="Projects carousel"
        tabindex="0"
      >
        <ul class="track" id="track">
          {slides.map((src, i) => (
            <li class="slide" data-i={i}>
              <img
                src={src}
                alt={`Project ${i + 1}`}
                loading={i === 0 ? "eager" : "lazy"}
                decoding="async"
              />
            </li>
          ))}
        </ul>
      </div>

      <div class="dots" id="dots" role="tablist" aria-label="Project slide navigation">
        {slides.map((_, i) => (
          <button
            class="dot"
            type="button"
            data-index={i}
            aria-label={`Go to slide ${i + 1}`}
          />
        ))}
      </div>
    </div>
  </section>

  <script>
    const viewport = document.getElementById("viewport");
    const track = document.getElementById("track");
    const dots = document.querySelectorAll("#dots .dot");

    let index = 0;
    let animating = false;

    const normalize = (i, n) => (i % n + n) % n;

    const setActiveDot = () => {
      dots.forEach((d, i) => {
        if (i === index) d.setAttribute("data-active", "true");
        else d.removeAttribute("data-active");
      });
    };

    const shift = (dir) => {
      if (animating) return;
      animating = true;

      const n = dots.length;
      index = normalize(index + dir, n);
      setActiveDot();

      track.style.transition = "transform 320ms ease";
      track.style.transform = `translateX(${dir * -100}%)`;

      const onDone = () => {
        track.removeEventListener("transitionend", onDone);

        track.style.transition = "none";
        track.style.transform = "translateX(-100%)";

        if (dir === 1) track.appendChild(track.firstElementChild);
        else track.insertBefore(track.lastElementChild, track.firstElementChild);

        // force reflow so the no-transition transform applies
        track.offsetHeight;

        animating = false;
      };

      track.addEventListener("transitionend", onDone);
    };

    const init = () => {
      // Put last slide first so "current" is visually centered at -100%
      track.insertBefore(track.lastElementChild, track.firstElementChild);
      track.style.transform = "translateX(-100%)";
      setActiveDot();
    };

    // Dot navigation (moves step-by-step in shortest direction)
    dots.forEach((dot, target) => {
      dot.addEventListener("click", () => {
        if (target === index || animating) return;

        const n = dots.length;
        const forward = normalize(target - index, n);
        const backward = normalize(index - target, n);
        const dir = forward <= backward ? 1 : -1;
        const steps = Math.min(forward, backward);

        let k = 0;
        const step = () => {
          if (k >= steps) return;
          shift(dir);
          k++;
          setTimeout(step, 340);
        };
        step();
      });
    });

    // Mouse wheel / trackpad paging
    let wheelLock = false;
    viewport.addEventListener(
      "wheel",
      (e) => {
        e.preventDefault();
        if (wheelLock || animating) return;
        wheelLock = true;

        // Use whichever axis is dominant
        const dominant = Math.abs(e.deltaY) >= Math.abs(e.deltaX) ? e.deltaY : e.deltaX;
        shift(dominant > 0 ? 1 : -1);

        setTimeout(() => (wheelLock = false), 360);
      },
      { passive: false }
    );

    // Basic swipe/drag (snap on release)
    let startX = 0;
    let dragging = false;

    viewport.addEventListener("pointerdown", (e) => {
      if (animating) return;
      dragging = true;
      startX = e.clientX;
      viewport.setPointerCapture?.(e.pointerId);
    });

    viewport.addEventListener("pointerup", (e) => {
      if (!dragging || animating) return;
      dragging = false;

      const dx = e.clientX - startX;
      const threshold = Math.min(90, viewport.clientWidth * 0.18);

      if (dx < -threshold) shift(1);
      else if (dx > threshold) shift(-1);
    });

    viewport.addEventListener("pointercancel", (e) => {
      dragging = false;
    });

    // Optional keyboard controls when focused
    viewport.addEventListener("keydown", (e) => {
      if (animating) return;
      if (e.key === "ArrowRight") shift(1);
      if (e.key === "ArrowLeft") shift(-1);
    });

    init();
  </script>

  <style>
    .home-wrap{
      display: grid;
      gap: 16px;
      justify-items: start;
      align-items: start;
      margin-inline: auto;
      width: 100%;
      padding-top: clamp(16px, 4vh, 48px);
      padding-bottom: clamp(24px, 6vh, 64px);
    }

    /* Width cap without Carousel.astro */
    .projects{
      width: 100%;
      max-width: 980px;
    }

    .viewport{
      width: 100%;
      overflow: hidden;
      border-radius: 16px;

      /* Keeps it from getting huge */
      height: clamp(220px, 45vh, 520px);

      /* lets it receive keyboard focus styles from your theme */
      outline: none;
    }

    /* 3-pane track: prev | current | next */
    .track{
      display: flex;
      width: 300%;
      transform: translateX(-100%);
    }

    .slide{
      width: 100%;
      flex: 0 0 100%;
      height: 100%;
      overflow: hidden;
    }

    .slide img{
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;
      object-position: center;
    }

    /* Dots */
    .dots{
      margin-top: 0.9rem;
      display: flex;
      justify-content: center;
      gap: 10px;
      width: 100%;
    }

    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 0;
      background: currentColor;
      opacity: 0.35;
      cursor: pointer;
      transition: transform 160ms ease, opacity 160ms ease;
      position: relative;
    }

    .dot[data-active="true"]{
      opacity: 1;
      transform: scale(1.35);
    }

    /* Bigger hit target */
    .dot::before{
      content: "";
      position: absolute;
      inset: -10px;
    }
  </style>
</Layout>
